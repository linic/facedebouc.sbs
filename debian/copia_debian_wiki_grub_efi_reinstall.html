<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>GrubEFIReinstall - Debian Wiki</title>
<link rel="alternate" title="Debian Wiki: GrubEFIReinstall" href="https://wiki.debian.org/GrubEFIReinstall?diffs=1&amp;show_att=1&amp;action=rss_rc&amp;unique=0&amp;page=GrubEFIReinstall&amp;ddiffs=1" type="application/rss+xml">
<link rel="Start" href="https://wiki.debian.org/FrontPage">
<link rel="Alternate" title="Wiki Markup" href="https://wiki.debian.org/GrubEFIReinstall?action=raw">
<link rel="Alternate" media="print" title="Print View" href="https://wiki.debian.org/GrubEFIReinstall?action=print">
<link rel="Search" href="https://wiki.debian.org/FindPage">
<link rel="Index" href="https://wiki.debian.org/TitleIndex">
<link rel="Glossary" href="https://wiki.debian.org/WordIndex">
<link rel="Help" href="https://wiki.debian.org/HelpOnFormatting">
</head>

<body lang="en" dir="ltr">
<p>THIS PAGE IS A COPY OF https://wiki.debian.org/GrubEFIReinstall ALL THE CREDIT GOES TO
THE ORIGINAL AUTHORS.</p>
<h1 id="locationline">
<a href="https://wiki.debian.org/GrubEFIReinstall">GrubEFIReinstall</a>
</h1>
</div>

<div id="page" lang="en" dir="ltr">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><p class="line862">Starting with Windows 8 most Desktop PC have EFI as firmware instead of the legacy <a href="https://wiki.debian.org/BIOS">BIOS</a>. <span class="anchor" id="line-2"></span>If
 your EFI based PC is not booting Debian, here are some ways to 
reinstall grub-efi, the bootloader used by Debian on these PCs. <span class="anchor" id="line-3"></span></p><div class="table-of-contents"><p class="table-of-contents-heading">Contents</p><ol><li>
<a href="#Using_A_Live_CD.2FUSB_To_Fix_Your_Current_System">Using A Live CD/USB To Fix Your Current System</a></li><li>
<a href="#Using_the_rEFInd_rescue_media">Using the rEFInd rescue media</a><ol><li>
<a href="#Boot_your_computer_with_the_Refind_media">Boot your computer with the Refind media</a></li><li>
<a href="#Reinstalling_grub-efi_on_your_hard_drive">Reinstalling grub-efi on your hard drive</a></li></ol></li><li>
<a href="#Troubleshooting">Troubleshooting</a><ol><li>
<a href="#Problem1:_Weak_EFI_implementation_only_recognizes_the_fallback_bootloader">Problem1: Weak EFI implementation only recognizes the fallback bootloader</a></li><li>
<a href="#Problem2:_EFI_boot_entries_disappear_after_reboot">Problem2: EFI boot entries disappear after reboot</a></li></ol></li></ol></div> <span class="anchor" id="line-4"></span><span class="anchor" id="line-5"></span><span class="anchor" id="line-6"></span><p class="line874">To
 reinstall grub, you need either a live CD/USB to access your current 
system, or you can use the rEFInd boot manager on a live CD/USB to boot 
your current system. <span class="anchor" id="line-7"></span><span class="anchor" id="line-8"></span></p><p class="line867">
</p><h2 id="Using_A_Live_CD.2FUSB_To_Fix_Your_Current_System">Using A Live CD/USB To Fix Your Current System</h2>
<span class="anchor" id="line-9"></span><span class="anchor" id="line-10"></span><p class="line862">(The following procedure is described in greater detail <a class="https" href="https://help.ubuntu.com/community/Grub2/Installing#via_ChRoot">here</a>.) <span class="anchor" id="line-11"></span><span class="anchor" id="line-12"></span></p><ol type="1"><li><p class="line862">Boot (using UEFI) into a live system, such as a <a href="https://wiki.debian.org/DebianLive">DebianLive</a> CD/USB or the <a href="https://wiki.debian.org/DebianInstaller/Rescue">Debian installer in rescue mode</a>. You can verify that the system has booted using UEFI by checking for the existence of the directory <tt class="backtick">/sys/firmware/efi</tt> or by running <tt class="backtick">efibootmgr</tt>. <span class="anchor" id="line-13"></span><span class="anchor" id="line-14"></span></p></li><li class="gap">If
 the directory /sys/firmware/efi/efivars is empty, you need to boot the 
rescue system including the kernel option "efi=runtime" and mount the 
EFI variables before proceeding: <span class="anchor" id="line-15"></span><span class="anchor" id="line-16"></span><span class="anchor" id="line-17"></span><pre><span class="anchor" id="line-1"></span># mount -t efivarfs none /sys/firmware/efi/efivars</pre><span class="anchor" id="line-18"></span><span class="anchor" id="line-19"></span></li><li class="gap">Mount
 the broken system somewhere into the running filesystem. The exact 
details of how to do this depend on the particulars of your 
installation. <span class="anchor" id="line-20"></span><span class="anchor" id="line-21"></span><p class="line862">For example, for a system with an EFI partition on <tt class="backtick">/dev/sdb1</tt>, an unencrypted <tt class="backtick">/boot</tt> partition on <tt class="backtick">/dev/sdb2</tt>, and an unencrypted <tt class="backtick">/</tt> partition on <tt class="backtick">/dev/sdb3</tt>, do: <span class="anchor" id="line-22"></span><span class="anchor" id="line-23"></span><span class="anchor" id="line-24"></span><span class="anchor" id="line-25"></span><span class="anchor" id="line-26"></span></p><pre><span class="anchor" id="line-1-1"></span># mount /dev/sdb3 /mnt
<span class="anchor" id="line-2"></span># mount /dev/sdb2 /mnt/boot
<span class="anchor" id="line-3"></span># mount /dev/sdb1 /mnt/boot/efi</pre><span class="anchor" id="line-27"></span><span class="anchor" id="line-28"></span><span class="anchor" id="line-29"></span><p class="line862">Another example - for a system with an EFI partition on <tt class="backtick">/dev/sdb1</tt> and <tt class="backtick">/</tt> partition on <tt class="backtick">/dev/sdb2</tt>, do: <span class="anchor" id="line-30"></span><span class="anchor" id="line-31"></span><span class="anchor" id="line-32"></span><span class="anchor" id="line-33"></span></p><pre><span class="anchor" id="line-1-2"></span># mount /dev/sdb2 /mnt/
<span class="anchor" id="line-2-1"></span># mount /dev/sdb1 /mnt/boot/efi</pre><span class="anchor" id="line-34"></span><span class="anchor" id="line-35"></span><p class="line862">In case of a LUKS-encrypted <tt class="backtick">/</tt> partition, please follow this guide: <a href="https://wiki.debian.org/GrubEFIReinstallOnLUKS">GrubEFIReinstallOnLUKS</a>. <span class="anchor" id="line-36"></span><span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span></p></li><li class="gap">Bind mount various virtual filesystems: <span class="anchor" id="line-39"></span><span class="anchor" id="line-40"></span><span class="anchor" id="line-41"></span><pre><span class="anchor" id="line-1-3"></span># for i in /dev /dev/pts /proc /sys /sys/firmware/efi/efivars /run; do mount -B $i /mnt/$i; done</pre><span class="anchor" id="line-42"></span><span class="anchor" id="line-43"></span>The mount executable supplied with busybox does not support the -B option, use "mount -o bind" in this case. <span class="anchor" id="line-44"></span><span class="anchor" id="line-45"></span></li><li class="gap">Chroot into the broken system: <span class="anchor" id="line-46"></span><span class="anchor" id="line-47"></span><span class="anchor" id="line-48"></span><pre><span class="anchor" id="line-1-4"></span># chroot /mnt</pre><span class="anchor" id="line-49"></span><span class="anchor" id="line-50"></span></li><li class="gap">Reinstall GRUB to the appropriate disk (without partition number): <span class="anchor" id="line-51"></span><span class="anchor" id="line-52"></span><span class="anchor" id="line-53"></span><pre><span class="anchor" id="line-1-5"></span># grub-install /dev/sdb</pre><span class="anchor" id="line-54"></span><span class="anchor" id="line-55"></span></li><li class="gap">Generate the GRUB configuration file: <span class="anchor" id="line-56"></span><span class="anchor" id="line-57"></span><span class="anchor" id="line-58"></span><pre><span class="anchor" id="line-1-6"></span># update-grub</pre><span class="anchor" id="line-59"></span></li><li><p class="line862">Exit the <tt class="backtick">chroot</tt> environment (&lt;CTRL&gt;-D). <span class="anchor" id="line-60"></span><span class="anchor" id="line-61"></span></p></li><li class="gap">If everything worked, reboot. <span class="anchor" id="line-62"></span><span class="anchor" id="line-63"></span></li></ol><p class="line867">
</p><h2 id="Using_the_rEFInd_rescue_media">Using the rEFInd rescue media</h2>
<span class="anchor" id="line-64"></span><span class="anchor" id="line-65"></span><p class="line862">At the author's web page, <a class="http" href="http://www.rodsbooks.com/refind/getting.html">http://www.rodsbooks.com/refind/getting.html</a>, you will find updated direct links to all sorts of packaging. <span class="anchor" id="line-66"></span>To
 boot from a rescue media, select either the CD ISO image or the image 
for USB sticks. Most firmware offers the choice nowadays. <span class="anchor" id="line-67"></span><tt>If&nbsp;choosing&nbsp;the&nbsp;latter,&nbsp;make&nbsp;sure&nbsp;to&nbsp;follow&nbsp;the&nbsp;instructions&nbsp;in&nbsp;the&nbsp;README</tt>. <span class="anchor" id="line-68"></span>It is recommended to read the author's web pages to get a better understanding of what you are doing. <span class="anchor" id="line-69"></span><span class="anchor" id="line-70"></span></p><p class="line867">
</p><h3 id="Boot_your_computer_with_the_Refind_media">Boot your computer with the Refind media</h3>
<span class="anchor" id="line-71"></span><span class="anchor" id="line-72"></span><p class="line874">rEFInd will parse your hard drive for installed kernels, and provide you a graphic menu to boot them. <span class="anchor" id="line-73"></span>Choose your Linux Kernel and boot it. <span class="anchor" id="line-74"></span><span class="anchor" id="line-75"></span></p><p class="line867">
</p><h3 id="Reinstalling_grub-efi_on_your_hard_drive">Reinstalling grub-efi on your hard drive</h3>
<span class="anchor" id="line-76"></span><span class="anchor" id="line-77"></span><p class="line874">Check that the computer booted in computer in EFI mode: <span class="anchor" id="line-78"></span><span class="anchor" id="line-79"></span><span class="anchor" id="line-80"></span><span class="anchor" id="line-81"></span></p><pre><span class="anchor" id="line-1-7"></span>[ -d /sys/firmware/efi ] &amp;&amp; echo "EFI boot on HDD" || echo "Legacy boot on HDD"
<span class="anchor" id="line-2-2"></span>should return "EFI boot on HDD".</pre><span class="anchor" id="line-82"></span><span class="anchor" id="line-83"></span><span class="anchor" id="line-84"></span><p class="line862">After starting a root shell (if you boot from a live media, you should start a chroot shell instead, as explained <a class="https" href="https://help.ubuntu.com/community/Grub2/Installing#via_ChRoot">here</a>)
 check that your EFI system partition (most probably  /dev/sdb1) is 
mounted on /boot/efi. If the /boot/efi directory does not exist, you 
will need to create it. <span class="anchor" id="line-85"></span><span class="anchor" id="line-86"></span><span class="anchor" id="line-87"></span></p><pre><span class="anchor" id="line-1-8"></span>mount /dev/sdb1 /boot/efi</pre><span class="anchor" id="line-88"></span><span class="anchor" id="line-89"></span><span class="anchor" id="line-90"></span><p class="line874">Reinstall the grub-efi package <span class="anchor" id="line-91"></span><span class="anchor" id="line-92"></span><span class="anchor" id="line-93"></span></p><pre><span class="anchor" id="line-1-9"></span>apt-get install --reinstall grub-efi</pre><span class="anchor" id="line-94"></span><span class="anchor" id="line-95"></span><p class="line874">Put the Debian bootloader in /boot/efi and create an appropriate entry in the computer NVRAM <span class="anchor" id="line-96"></span><span class="anchor" id="line-97"></span><span class="anchor" id="line-98"></span></p><pre><span class="anchor" id="line-1-10"></span>grub-install</pre><span class="anchor" id="line-99"></span><span class="anchor" id="line-100"></span><p class="line874">Re create a grub config file based on your disk partitioning schema <span class="anchor" id="line-101"></span><span class="anchor" id="line-102"></span><span class="anchor" id="line-103"></span></p><pre><span class="anchor" id="line-1-11"></span>update-grub</pre><span class="anchor" id="line-104"></span><span class="anchor" id="line-105"></span><p class="line874">You should check afterwards that: <span class="anchor" id="line-106"></span><span class="anchor" id="line-107"></span></p><p class="line874">Check 1. the bootloader is existing in /boot/efi/EFI/debian/grubx64.efi <span class="anchor" id="line-108"></span><span class="anchor" id="line-109"></span><span class="anchor" id="line-110"></span><span class="anchor" id="line-111"></span><span class="anchor" id="line-112"></span></p><pre><span class="anchor" id="line-1-12"></span>file /boot/efi/EFI/debian/grubx64.efi
<span class="anchor" id="line-2-3"></span>
<span class="anchor" id="line-3-1"></span>/boot/efi/EFI/debian/grubx64.efi: PE32+ executable (EFI application) x86-64 (stripped to external PDB), for MS Windows</pre><span class="anchor" id="line-113"></span><span class="anchor" id="line-114"></span><p class="line874">Check 2. the NVRAM entry was properly created. <span class="anchor" id="line-115"></span><span class="anchor" id="line-116"></span></p><p class="line867"><span class="anchor" id="line-117"></span><span class="anchor" id="line-118"></span></p><pre><span class="anchor" id="line-1-13"></span>efibootmgr --verbose | grep debian</pre><span class="anchor" id="line-119"></span><span class="anchor" id="line-120"></span><p class="line874">You can now reboot, and Grub should greet you. <span class="anchor" id="line-121"></span><span class="anchor" id="line-122"></span></p><p class="line867">
</p><h2 id="Troubleshooting">Troubleshooting</h2>
<span class="anchor" id="line-123"></span><span class="anchor" id="line-124"></span><p class="line874">If after this steps you're not booting, the EFI of your PC might have some bugs. <span class="anchor" id="line-125"></span><span class="anchor" id="line-126"></span></p><p class="line867">
</p><h3 id="Problem1:_Weak_EFI_implementation_only_recognizes_the_fallback_bootloader">Problem1: Weak EFI implementation only recognizes the fallback bootloader</h3>
<span class="anchor" id="line-127"></span><p class="line862">The UEFI 
firmware refuses to boot the debian/grubx64.efi bootloader, and so we 
have to hijack the UEFI fallback boot loader. See <a class="http" href="http://mjg59.livejournal.com/138188.html">http://mjg59.livejournal.com/138188.html</a> for details. <span class="anchor" id="line-128"></span><span class="anchor" id="line-129"></span></p><p class="line874">Using Debian installer in rescue mode, /dev/sdb1 being the FAT32 ESP partition, /dev/sdb2 the root partition <span class="anchor" id="line-130"></span><span class="anchor" id="line-131"></span><span class="anchor" id="line-132"></span><span class="anchor" id="line-133"></span><span class="anchor" id="line-134"></span><span class="anchor" id="line-135"></span><span class="anchor" id="line-136"></span></p><pre><span class="anchor" id="line-1-14"></span>mkdir /target
<span class="anchor" id="line-2-4"></span>mount /dev/sdb2 /target
<span class="anchor" id="line-3-2"></span>mount /dev/sdb1 /target/boot/efi
<span class="anchor" id="line-4"></span>for i in /sys /proc /dev; do mount --bind $i /target$i; done
<span class="anchor" id="line-5"></span>chroot /target</pre><span class="anchor" id="line-137"></span><span class="anchor" id="line-138"></span><p class="line867"><span class="anchor" id="line-139"></span><span class="anchor" id="line-140"></span><span class="anchor" id="line-141"></span><span class="anchor" id="line-142"></span><span class="anchor" id="line-143"></span><span class="anchor" id="line-144"></span><span class="anchor" id="line-145"></span><span class="anchor" id="line-146"></span></p><pre><span class="anchor" id="line-1-15"></span>cd /boot/efi/EFI
<span class="anchor" id="line-2-5"></span>mkdir boot
<span class="anchor" id="line-3-3"></span>cp debian/grubx64.efi boot/bootx64.efi
<span class="anchor" id="line-4-1"></span>exit
<span class="anchor" id="line-5-1"></span>for i in /sys /proc /dev; do umount /target$i; done
<span class="anchor" id="line-6"></span>umount /target/boot/efi
<span class="anchor" id="line-7"></span>umount /target</pre><span class="anchor" id="line-147"></span><span class="anchor" id="line-148"></span><p class="line874">Once booted into your normal Debian, tell grub to ensure the fallback boot loader up to date. To do that, run the following: <span class="anchor" id="line-149"></span><span class="anchor" id="line-150"></span><span class="anchor" id="line-151"></span></p><pre><span class="anchor" id="line-1-16"></span>echo "grub-efi-amd64 grub2/force_efi_extra_removable boolean true" | sudo debconf-set-selections</pre><span class="anchor" id="line-152"></span><p class="line874">Note: The above command will permanently hijack the fallback bootloader, which might be undesirable in dual-boot setups. <span class="anchor" id="line-153"></span><span class="anchor" id="line-154"></span></p><p class="line867">
</p><h3 id="Problem2:_EFI_boot_entries_disappear_after_reboot">Problem2: EFI boot entries disappear after reboot</h3>
<span class="anchor" id="line-155"></span><p class="line874">The UEFI firmware did not create a proper boot entry in NVRAM. This has been seen in a Lenovo Thinkcenter M92Z. <span class="anchor" id="line-156"></span>The symptom for this will be a missing HD path after the Debian entry in the <tt class="backtick">efibootmgr&nbsp;--verbose</tt> output. <span class="anchor" id="line-157"></span><span class="anchor" id="line-158"></span></p><p class="line867"><span class="anchor" id="line-159"></span><span class="anchor" id="line-160"></span><span class="anchor" id="line-161"></span><span class="anchor" id="line-162"></span><span class="anchor" id="line-163"></span><span class="anchor" id="line-164"></span><span class="anchor" id="line-165"></span><span class="anchor" id="line-166"></span><span class="anchor" id="line-167"></span></p><pre><span class="anchor" id="line-1-17"></span>BootCurrent: 0024
<span class="anchor" id="line-2-6"></span>Timeout: 0 seconds
<span class="anchor" id="line-3-4"></span>BootOrder: 0024,0022,0023,0016,0000,0001
<span class="anchor" id="line-4-2"></span>Boot0000* debian        Vendor(99e275e7-75a0-4b37-a2e6-c5385e6c00cb,)
<span class="anchor" id="line-5-2"></span>Boot0016* Generic Usb Device    Vendor(99e275e7-75a0-4b37-a2e6-c5385e6c00cb,)
<span class="anchor" id="line-6-1"></span>Boot0022* UEFI: IPv4 Intel(R) 82579LM Gigabit Network Connection        ACPI(a0341d0,0)PCI(19,0)MAC(d43d7e6d8bfc,0)IPv4(0.0.0.0:0&lt;-&gt;0.0.0.0:0,0, 0AMBO
<span class="anchor" id="line-7-1"></span>Boot0023* UEFI: IPv6 Intel(R) 82579LM Gigabit Network Connection        ACPI(a0341d0,0)PCI(19,0)MAC(d43d7e6d8bfc,0)030d3c000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000AMBO
<span class="anchor" id="line-8"></span>Boot0024* UEFI: Generic Flash Disk 8.00 ACPI(a0341d0,0)PCI(1d,0)USB(1,0)USB(1,0)HD(1,800,2a5f,02f23208-1aa9-4b6c-b6e1-8155390eb9db)AMBO</pre><span class="anchor" id="line-168"></span><span class="anchor" id="line-169"></span><p class="line862">You can then try to install rEFInd as your bootloader in the hard drive, following the steps at this gist: <a class="https" href="https://gist.github.com/EmmanuelKasper/9590327">https://gist.github.com/EmmanuelKasper/9590327</a>. <span class="anchor" id="line-170"></span><span class="anchor" id="line-171"></span></p><p class="line867"></p><hr><p class="line874"> <span class="anchor" id="line-172"></span><a href="https://wiki.debian.org/CategoryBootProcess">CategoryBootProcess</a> <a href="https://wiki.debian.org/RescueLive">RescueLive</a> <span class="anchor" id="line-173"></span></p><hr><p class="line874"> <span class="anchor" id="line-174"></span><a href="https://wiki.debian.org/CategoryBootProcess">CategoryBootProcess</a> <span class="anchor" id="line-175"></span><span class="anchor" id="bottom"></span></p></div><div id="pagebottom"></div>
</div>

</body></html>
